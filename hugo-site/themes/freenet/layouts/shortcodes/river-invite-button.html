<style>
.invite-container {
    max-width: 480px;
    margin: 1.5rem 0;
    padding: 1.5rem;
    border: 1px solid rgba(0, 102, 204, 0.2);
    border-radius: 12px;
    background-color: #f8fafc;
    color: #363636;
}

.invite-container p {
    margin-bottom: 1rem;
    color: inherit;
    line-height: 1.6;
}

.invite-container h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    font-size: 1.1rem;
    color: inherit;
}

.invite-container .invite-btn {
    display: inline-block;
    padding: 0.875rem 1.5rem;
    font-size: 1rem;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    text-decoration: none;
    text-align: center;
    transition: all 0.2s ease;
}

.invite-container .invite-btn-primary {
    background: linear-gradient(135deg, #0066CC 0%, #004C99 100%);
    color: white;
    width: 100%;
    box-shadow: 0 4px 14px rgba(0, 102, 204, 0.25);
}

.invite-container .invite-btn-primary:hover {
    background: linear-gradient(135deg, #0066cc 0%, #005cbf 100%);
    box-shadow: 0 6px 20px rgba(0, 102, 204, 0.35);
    transform: translateY(-1px);
}

.invite-container .invite-link-btn {
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    color: white;
    font-size: 1.1rem;
    padding: 1rem 2rem;
    margin: 1rem 0;
    width: 100%;
    box-sizing: border-box;
    box-shadow: 0 4px 14px rgba(34, 197, 94, 0.25);
}

.invite-container .invite-link-btn:hover {
    background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
    color: white;
    text-decoration: none;
    box-shadow: 0 6px 20px rgba(34, 197, 94, 0.35);
    transform: translateY(-1px);
}

.invite-container .success-text {
    color: #16a34a;
    font-weight: 600;
    font-size: 1.1rem;
    margin-bottom: 1rem;
}

.invite-container .error-text {
    color: #dc2626;
}

.invite-container .loading-text {
    text-align: center;
    padding: 1.25rem;
    color: inherit;
}

.invite-container .note {
    font-size: 0.875rem;
    color: #64748b;
    margin-top: 0.75rem;
}

@media (prefers-color-scheme: dark) {
    .invite-container {
        background-color: #1a1a1a;
        border-color: rgba(77, 166, 255, 0.2);
        color: #f5f5f5;
    }

    .invite-container .invite-btn-primary {
        box-shadow: 0 4px 14px rgba(0, 102, 204, 0.3);
    }

    .invite-container .invite-link-btn {
        box-shadow: 0 4px 14px rgba(34, 197, 94, 0.3);
    }

    .invite-container .note {
        color: #94a3b8;
    }

    .invite-container .success-text {
        color: #4ade80;
    }
}
</style>

<div class="invite-container">
    <div id="invite-form">
        <p>Get your invite to <strong>{{ .Get "room" | default "Freenet Chat" }}</strong></p>
        <button id="get-invite-btn" class="invite-btn invite-btn-primary">
            Get Invite Code
        </button>
    </div>

    <div id="invite-result" style="display: none;">
        <p class="success-text">Your invite is ready!</p>

        <p>Click the button below to open River and join the chat:</p>
        <a id="invite-link" href="#" target="_blank" class="invite-btn invite-link-btn">
            Open River &amp; Join Chat
        </a>

        <p class="note">Make sure Freenet is running. Please be patientâ€”River may take a while to load when your peer first starts.</p>
    </div>

    <div id="invite-error" style="display: none;">
        <p id="error-message" class="error-text"></p>
        <p id="retry-message" style="font-size: 14px;"></p>
    </div>

    <div id="invite-loading" style="display: none;">
        <p class="loading-text">Generating invite...</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const apiUrl = window.ghostkeyApiUrl;
    const riverBaseUrl = 'http://127.0.0.1:7509/v1/contract/web/raAqMhMG7KUpXBU2SxgCQ3Vh4PYjttxdSWd9ftV7RLv/';

    const getInviteBtn = document.getElementById('get-invite-btn');
    const inviteForm = document.getElementById('invite-form');
    const inviteResult = document.getElementById('invite-result');
    const inviteError = document.getElementById('invite-error');
    const inviteLoading = document.getElementById('invite-loading');
    const inviteLink = document.getElementById('invite-link');
    const errorMessage = document.getElementById('error-message');
    const retryMessage = document.getElementById('retry-message');

    getInviteBtn.addEventListener('click', async function() {
        inviteForm.style.display = 'none';
        inviteLoading.style.display = 'block';
        inviteError.style.display = 'none';
        inviteResult.style.display = 'none';

        try {
            const response = await fetch(`${apiUrl}/create-invite`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });

            if (response.status === 429) {
                const data = await response.json();
                inviteLoading.style.display = 'none';
                inviteError.style.display = 'block';
                errorMessage.textContent = data.error;
                if (data.retry_after_seconds) {
                    const hours = Math.ceil(data.retry_after_seconds / 3600);
                    retryMessage.textContent = `You can try again in approximately ${hours} hour(s).`;
                }
                return;
            }

            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`);
            }

            const data = await response.json();
            const inviteCode = data.invite_code;

            // Set the invite link URL
            inviteLink.href = `${riverBaseUrl}?invitation=${encodeURIComponent(inviteCode)}`;

            inviteLoading.style.display = 'none';
            inviteResult.style.display = 'block';

        } catch (error) {
            inviteLoading.style.display = 'none';
            inviteError.style.display = 'block';
            errorMessage.textContent = `Error: ${error.message}. Please try again later.`;
            retryMessage.textContent = '';
        }
    });
});
</script>
