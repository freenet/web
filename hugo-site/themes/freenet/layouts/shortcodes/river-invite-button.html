<style>
.invite-container {
    max-width: 500px;
    margin: 20px auto;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 10px;
    background-color: #f5f5f5;
    color: #363636;
}

.invite-container p {
    margin-bottom: 15px;
    color: inherit;
}

.invite-container .invite-btn {
    width: 100%;
    padding: 12px;
    font-size: 16px;
    font-weight: 500;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.invite-container .invite-btn-primary {
    background-color: #3273dc;
    color: white;
}

.invite-container .invite-btn-primary:hover {
    background-color: #2366d1;
}

.invite-container .invite-btn-secondary {
    background-color: #48c774;
    color: white;
    margin-top: 10px;
    width: auto;
    padding: 10px 20px;
}

.invite-container .invite-btn-secondary:hover {
    background-color: #3abb67;
}

.invite-container .success-text {
    color: #48c774;
    font-weight: 500;
    margin-bottom: 10px;
}

.invite-container .error-text {
    color: #f14668;
}

.invite-container .invite-code-textarea {
    width: 100%;
    height: 100px;
    font-family: monospace;
    font-size: 12px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background-color: #fff;
    color: #363636;
    resize: none;
}

.invite-container .loading-text {
    text-align: center;
    padding: 20px;
    color: inherit;
}

.invite-container a {
    color: #3273dc;
}

@media (prefers-color-scheme: dark) {
    .invite-container {
        background-color: #2b2b2b;
        border-color: #4a4a4a;
        color: #f5f5f5;
    }

    .invite-container .invite-code-textarea {
        background-color: #1a1a1a;
        color: #f5f5f5;
        border-color: #4a4a4a;
    }

    .invite-container a {
        color: #7eb8ff;
    }
}
</style>

<div class="invite-container">
    <div id="invite-form">
        <p>Get your invite to <strong>{{ .Get "room" | default "Freenet Chat" }}</strong></p>
        <button id="get-invite-btn" class="invite-btn invite-btn-primary">
            Get Invite Code
        </button>
    </div>

    <div id="invite-result" style="display: none;">
        <p class="success-text">Success! Here's your invite code:</p>
        <textarea id="invite-code" class="invite-code-textarea" readonly></textarea>
        <button id="copy-btn" class="invite-btn invite-btn-secondary">
            Copy to Clipboard
        </button>
        <p style="margin-top: 15px; font-size: 14px;">
            Open <a href="http://127.0.0.1:7509/v1/contract/web/raAqMhMG7KUpXBU2SxgCQ3Vh4PYjttxdSWd9ftV7RLv/" target="_blank">River</a> and paste this code to join the room.
        </p>
    </div>

    <div id="invite-error" style="display: none;">
        <p id="error-message" class="error-text"></p>
        <p id="retry-message" style="font-size: 14px;"></p>
    </div>

    <div id="invite-loading" style="display: none;">
        <p class="loading-text">Generating invite...</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const apiUrl = window.ghostkeyApiUrl;
    const getInviteBtn = document.getElementById('get-invite-btn');
    const inviteForm = document.getElementById('invite-form');
    const inviteResult = document.getElementById('invite-result');
    const inviteError = document.getElementById('invite-error');
    const inviteLoading = document.getElementById('invite-loading');
    const inviteCode = document.getElementById('invite-code');
    const copyBtn = document.getElementById('copy-btn');
    const errorMessage = document.getElementById('error-message');
    const retryMessage = document.getElementById('retry-message');

    getInviteBtn.addEventListener('click', async function() {
        inviteForm.style.display = 'none';
        inviteLoading.style.display = 'block';
        inviteError.style.display = 'none';
        inviteResult.style.display = 'none';

        try {
            const response = await fetch(`${apiUrl}/create-invite`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });

            if (response.status === 429) {
                // Rate limited
                const data = await response.json();
                inviteLoading.style.display = 'none';
                inviteError.style.display = 'block';
                errorMessage.textContent = data.error;
                if (data.retry_after_seconds) {
                    const hours = Math.ceil(data.retry_after_seconds / 3600);
                    retryMessage.textContent = `You can try again in approximately ${hours} hour(s).`;
                }
                return;
            }

            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`);
            }

            const data = await response.json();
            inviteLoading.style.display = 'none';
            inviteResult.style.display = 'block';
            inviteCode.value = data.invite_code;

        } catch (error) {
            inviteLoading.style.display = 'none';
            inviteError.style.display = 'block';
            errorMessage.textContent = `Error: ${error.message}. Please try again later.`;
            retryMessage.textContent = '';
        }
    });

    copyBtn.addEventListener('click', function() {
        inviteCode.select();
        inviteCode.setSelectionRange(0, 99999); // For mobile

        navigator.clipboard.writeText(inviteCode.value).then(function() {
            copyBtn.textContent = 'Copied!';
            setTimeout(() => {
                copyBtn.textContent = 'Copy to Clipboard';
            }, 2000);
        }).catch(function() {
            // Fallback for older browsers
            document.execCommand('copy');
            copyBtn.textContent = 'Copied!';
            setTimeout(() => {
                copyBtn.textContent = 'Copy to Clipboard';
            }, 2000);
        });
    });
});
</script>
