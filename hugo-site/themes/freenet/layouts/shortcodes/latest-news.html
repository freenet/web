{{ $tag := .Get "tag" | default "front-page" }}
{{ $includeReleases := .Get "include-releases" | default "false" }}
{{ $news := where .Site.RegularPages "Section" "news" }}
{{ $news := where $news "Params.tags" "intersect" (slice $tag) }}
{{ $sortedNews := sort $news "Date" "desc" }}

{{ if eq $includeReleases "true" }}
  {{/* Build JSON array of static news items for JavaScript */}}
  {{ $newsItems := slice }}
  {{ range first 10 $sortedNews }}
    {{ $tags := .Params.tags | default slice }}
    {{ $newsItems = $newsItems | append (dict "date" (.Date.Format "2006-01-02T15:04:05Z") "title" .Title "url" .Permalink "tags" $tags "type" "news") }}
  {{ end }}

  <div id="latest-news-container" data-news-items='{{ $newsItems | jsonify }}'>
    <p><em>Loading news...</em></p>
  </div>

  <script>
  (function() {
    const container = document.getElementById('latest-news-container');
    const staticNews = JSON.parse(container.dataset.newsItems);

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    }

    function renderNews(items) {
      // Sort by date descending
      items.sort((a, b) => new Date(b.date) - new Date(a.date));
      // Take first 5
      const top5 = items.slice(0, 5);

      let html = '<ul>';
      for (const item of top5) {
        html += `<li><strong>${formatDate(item.date)}</strong> - <a href="${item.url}">${item.title}</a></li>`;
      }
      html += '</ul>';
      container.innerHTML = html;
    }

    // Fetch latest GitHub release
    fetch('https://api.github.com/repos/freenet/freenet-core/releases?per_page=1')
      .then(response => response.json())
      .then(releases => {
        const releaseItems = releases
          .filter(r => !r.draft && !r.prerelease)
          .slice(0, 1)
          .map(r => ({
            date: r.published_at,
            title: `Freenet ${r.tag_name} Released`,
            url: r.html_url,
            type: 'release'
          }));

        // Merge and render
        const allItems = [...staticNews, ...releaseItems];
        renderNews(allItems);
      })
      .catch(err => {
        console.error('Failed to fetch releases:', err);
        // Fall back to static news only
        renderNews(staticNews);
      });
  })();
  </script>
{{ else }}
  <ul>
    {{ range first 5 $sortedNews }}
      <li>
        <strong>{{ .Date.Format "January 2, 2006" }}</strong> -
        <a href="{{ .Permalink }}">{{ .Title }}</a>
      </li>
    {{ end }}
  </ul>
{{ end }}
