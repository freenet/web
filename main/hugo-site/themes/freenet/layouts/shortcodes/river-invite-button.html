<div id="invite-container" style="max-width: 500px; margin: 20px auto; padding: 20px; border: 1px solid #ccc; border-radius: 10px; background-color: #f9f9f9;">
    <div id="invite-form">
        <p style="margin-bottom: 15px;">Get your invite to <strong>{{ .Get "room" | default "Freenet Chat" }}</strong></p>
        <button id="get-invite-btn" class="button is-primary" style="width: 100%; padding: 10px; background-color: #0066cc; color: white; border: none; border-radius: 5px; cursor: pointer;">
            Get Invite Code
        </button>
    </div>

    <div id="invite-result" style="display: none;">
        <p style="color: green; margin-bottom: 10px;">Success! Here's your invite code:</p>
        <textarea id="invite-code" readonly style="width: 100%; height: 100px; font-family: monospace; font-size: 12px; padding: 10px; border: 1px solid #ccc; border-radius: 5px;"></textarea>
        <button id="copy-btn" class="button is-info" style="margin-top: 10px; padding: 8px 16px; background-color: #3273dc; color: white; border: none; border-radius: 5px; cursor: pointer;">
            Copy to Clipboard
        </button>
        <p style="margin-top: 15px; font-size: 14px;">
            Open <a href="http://127.0.0.1:7509/v1/contract/web/raAqMhMG7KUpXBU2SxgCQ3Vh4PYjttxdSWd9ftV7RLv/" target="_blank">River</a> and paste this code to join the room.
        </p>
    </div>

    <div id="invite-error" style="display: none; color: red;">
        <p id="error-message"></p>
        <p id="retry-message" style="font-size: 14px;"></p>
    </div>

    <div id="invite-loading" style="display: none; text-align: center; padding: 20px;">
        Generating invite...
    </div>
</div>

<style>
@media (prefers-color-scheme: dark) {
    #invite-container {
        background-color: #2a2a2a;
        border-color: #444;
        color: #ffffff;
    }
    #invite-code {
        background-color: #1a1a1a;
        color: #ffffff;
        border-color: #444;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const apiUrl = window.ghostkeyApiUrl;
    const getInviteBtn = document.getElementById('get-invite-btn');
    const inviteForm = document.getElementById('invite-form');
    const inviteResult = document.getElementById('invite-result');
    const inviteError = document.getElementById('invite-error');
    const inviteLoading = document.getElementById('invite-loading');
    const inviteCode = document.getElementById('invite-code');
    const copyBtn = document.getElementById('copy-btn');
    const errorMessage = document.getElementById('error-message');
    const retryMessage = document.getElementById('retry-message');

    getInviteBtn.addEventListener('click', async function() {
        inviteForm.style.display = 'none';
        inviteLoading.style.display = 'block';
        inviteError.style.display = 'none';
        inviteResult.style.display = 'none';

        try {
            const response = await fetch(`${apiUrl}/create-invite`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });

            if (response.status === 429) {
                // Rate limited
                const data = await response.json();
                inviteLoading.style.display = 'none';
                inviteError.style.display = 'block';
                errorMessage.textContent = data.error;
                if (data.retry_after_seconds) {
                    const hours = Math.ceil(data.retry_after_seconds / 3600);
                    retryMessage.textContent = `You can try again in approximately ${hours} hour(s).`;
                }
                return;
            }

            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`);
            }

            const data = await response.json();
            inviteLoading.style.display = 'none';
            inviteResult.style.display = 'block';
            inviteCode.value = data.invite_code;

        } catch (error) {
            inviteLoading.style.display = 'none';
            inviteError.style.display = 'block';
            errorMessage.textContent = `Error: ${error.message}. Please try again later.`;
            retryMessage.textContent = '';
        }
    });

    copyBtn.addEventListener('click', function() {
        inviteCode.select();
        inviteCode.setSelectionRange(0, 99999); // For mobile

        navigator.clipboard.writeText(inviteCode.value).then(function() {
            copyBtn.textContent = 'Copied!';
            setTimeout(() => {
                copyBtn.textContent = 'Copy to Clipboard';
            }, 2000);
        }).catch(function() {
            // Fallback for older browsers
            document.execCommand('copy');
            copyBtn.textContent = 'Copied!';
            setTimeout(() => {
                copyBtn.textContent = 'Copy to Clipboard';
            }, 2000);
        });
    });
});
</script>
